# “Нечто” — Техническая спецификация

## 1. Общие сведения

| Пункт              | Содержимое                                                                 |
|--------------------|-----------------------------------------------------------------------------|
| Название проекта   | “Нечто • Digital Companion”                                                |
| Тип решения        | Web-приложение (PWA) + WebSocket-сервер                                   |
| Целевая аудитория  | 5–10 человек, играющих оффлайн за одним столом                            |
| Жизненный цикл     | MVP → Private Beta → Release (внутренний)                                 |

## 2. Цели и задачи

- Автоматизировать скрытые игровые механики (раздача ролей, фазы, события, паники, пересаживания, подсчёт победы).
- Сохранить живое общение: система не заменяет обсуждения и голос.
- Обеспечить единый UX на телефонах и ПК без установки из магазинов.

## 3. Область применения

- Игра проходит в одной физической комнате.
- Подключение через современный браузер по ссылке или QR-коду.
- Требуется доступ в интернет (WebSocket-сервер).

## 4. Требования к системе

### 4.1. Функциональные

**Лобби**
- Создание игры по клику “Новая игра” → генерация 6-символьного кода.
- Подключение игроков по коду / QR.
- Изменяемый список сидений (drag & drop).
- Проверка количества игроков и корректности сетапа.

**Старт партии**
- Случайная раздача скрытых ролей.
- Общий настраиваемый таймер подготовки (30–300 с).

**Игровые циклы**
- Чёткие фазы: Ночь → Обсуждение → Голосование → Событие/Паника.
- Система сама инициирует переходы, отображая подсказки.
- Возможность ручного Re-sync при сбоях.

**Карты и события**
- Пул карт на сервере.
- Поддержка пользовательских паков (импорт JSON).

**Пересаживания**
- Автоматическое предложение новой схемы сидений.
- Вывод схемы на все экраны + крупный QR-код.

**Завершение**
- Определение победившей стороны.
- Экран статистики (роли, действия, тайминги).
- Кнопка “Сыграть ещё” без выхода из лобби.

### 4.2. Нефункциональные

| Категория         | Цель                                                                 |
|-------------------|----------------------------------------------------------------------|
| Производительность| ≤ 150 мс отклик UI; ≤ 1 с переход фаз                                |
| Надёжность        | Автосохранение в Redis каждые 5 с; авто-reconnect                    |
| Безопасность      | TLS 1.3; хэш-ID игроков; роли по WSS — только адресату               |
| Масштабируемость  | До 20 параллельных лобби на 1 vCPU / 1 GiB сервер                    |
| Локализация       | RU (по умолчанию), EN — через i18n JSON-файлы                        |
| Доступность       | WCAG 2.1 AA: контраст, шрифты ≥ 14px, навигация без мыши             |

## 5. Архитектура и стек

### 5.1. Схема высокого уровня

![image](https://github.com/user-attachments/assets/bd7f409a-561e-4ee6-a5c1-be571a373c62)

### 5.2. Подробный стек

| Слой          | Технологии                                                                 | Причина выбора                                        |
|---------------|-----------------------------------------------------------------------------|--------------------------------------------------------|
| Frontend      | React 18, Vite, TypeScript, Zustand, Tailwind CSS, Workbox                 | Быстрый старт, PWA-фичи «из коробки»                   |
| Realtime      | Socket.io 4 (WSS)                                                           | Простая событийная модель, Binary Packets              |
| Backend       | Node.js 20 + Express Router                                                 | Единый стек JS, быстрая разработка                     |
| State Store   | Redis 7 (in-memory), JSON.stringify() snapshot каждые 5 с                  | Мгновенные операции, авто-reconnect                    |
| Persistent Logs | MongoDB Atlas                                                             | Долгосрочная статистика                                |
| Auth          | Без учёток; UUID + code; опционально Magic Link                            | Минимум трения                                         |
| CI/CD         | GitHub Actions → Vercel Deploy → Redis/Mongo в Docker                      | Однокнопочное деплой-превью                            |
| Testing       | Vitest, React-Testing-Library, Playwright (E2E)                            | Покрытие критичного UI и фаз                           |

## 6. UI / UX

**Экран “Лобби”**
- Список игроков (аватар, ник, место).
- Кнопки: “Изменить порядок”, “Начать игру”.

**Экран “Игра”**
- Шапка: текущая фаза + таймер.
- Центр: текст/иконка фазы.
- Нижняя панель: личные действия (“Просмотреть карту”).

**Экран “Сетап сидений”**
- Карусель аватаров + drag & drop.
- Крупный QR-код новой схемы.

**Экран “Результат”**
- Победа стороны, статистика, “Re-match”.

## 7. Безопасность

| Угроза                             | Мероприятие                                                                           |
|------------------------------------|----------------------------------------------------------------------------------------|
| Подглядывание ролей по сети        | Роли — личные зашифрованные события, хранятся только в IndexedDB клиента             |
| Потеря соединения                  | Сохранение фаз в Redis + локальный кэш в Service Worker                              |
| DDoS / спам-лобби                  | Ограничение: 1 лобби / IP за 3 мин; CAPTCHA при превышении                            |

## 8. Тестирование

- **Unit** — логика фаз, ролей, пересаживаний.
- **Integration** — нагрузка: 100 mock-клиентов через WSS.
- **E2E** — полная партия в Playwright (≥6 игроков).
- **UX-тест** — живой стол, запись экрана, опрос участников.

## 9. Путь разработки (Roadmap)

| Спринт             | 2-нед. цель              | Ключевые задачи                                       |
|--------------------|--------------------------|--------------------------------------------------------|
| 0 — Setup          | Repo + CI/CD             | Vite+TS шаблон, Socket.io hello-world, Redis compose  |
| 1 — Лобби          | Создание/подключение     | UI Lobby, генератор кода, drag & drop мест            |
| 2 — Роли           | Раздача ролей            | State-machine фаз, экран роли                         |
| 3 — Фазы ядра      | Ночь⇄День, голосование   | Таймеры, фазы, события                                |
| 4 — События        | Карты, паника            | JSON паки, UI всплывашек                              |
| 5 — Пересаживания  | Полный цикл игры         | Алгоритм, экран статистики                            |
| 6 — Beta           | Тест-полировка           | Баг-фиксы, i18n, offline-кэш                          |
| 7 — Release        | Частный релиз            | Документация, README, видеоруководство                |

## 10. Критерии готовности MVP

- 80 % сценария играется без хакапов.
- Переподключение не ломает партию.
- Есть: лобби, раздача, фазы, конец партии.
- Внешний тест (6–8 игроков) ≤ 60 минут.

## 11. Риски и пути смягчения

| Риск                            | Решение                                                               |
|----------------------------------|------------------------------------------------------------------------|
| Ограничения PWA на iOS          | Минимизировать фон-таймеры; критические ивенты — push-звук           |
| Потеря интернета                | Локальный сервер + точка доступа через роутер                         |
| Сложные правила для новичков   | Режим обучения, всплывающие подсказки                                 |

## 12. Ресурсы и лицензии

- React, Tailwind, Socket.io — MIT
- Redis, MongoDB Community — BSD-style / SSPL
- Графика карт — собственная или под CC-BY-SA

